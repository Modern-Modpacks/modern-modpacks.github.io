```yml
title: KubeJS scripts are inherently unsafe.
subtitle: Embrace it.
tag: 0
```

*Hello there.* Long time no see!

Depending on when you are reading this (and when I publish this), if you were to look at your calendar you might notice something - the 31st of October is *upon us!* Yes, that's right, spooky season has almost arrived at its grand finale - the lights are dimmed, the pumpkins are cut, and the neighborhood children are about to turn into all sort of different kinds of monsters to try and trick you into giving them your inner organs! Or candy, I don't know what the tradition is like in your country.

**But for most of y'all programmers nothing is going to change.** Another day spent coding in your mom's basement, with no joy in sight. But be not afraid, for if you don't feel that dreadful atmosphere, I am here to bring it to you! Strap in, because for this year's halloween we're going to talk about the only thing spookier than ghosts and carpeted kitchens - ***unsafe code.***

# Reflection and why we can't have nice things

If you've been living under ten layers of all kinds of different rocks - [**KubeJS**](https://kubejs.com/) is a mod developed by [Kristiāns Micītis](https://github.com/LatvianModder) (also known as LatvianDeveloper or simply Lat online). It, similarly to CraftTweaker, allows modpack developers to add custom content to the game, while not even touching the disgusting concept of a non-scripting language such as Java (eugh). Nowadays it is considered by many to be *the* scripting mod of choice (at least in newer versions), which can been seen by how rapidly it's approaching CT in downloads. 

And while the purpose of the two mods is the same, there are multiple major differences between CraftTweaker and Kube, with two notable examples:
1. KJS uses JavaScript - a toy language, while CT uses ZenScript - a fake language.
2. One of the features Kube has and CraftTweaker doesn't is what's called "*reflection*" - the ability to use fields and methods coming from Java classes directly inside JS scripts.

To an uninitiated person, the second point might at first sound very dangerous - and that's because it is! Giving scripts unlimited control over your PC can lead to a number of different "fun" consequences, with examples including (but are not being limited to): `rm -rf`-ing important unprotected system folders; downloading useless files to fill in your drive with a bunch of junk (or even worse, downloading and launching malware); reading confidential data from all across your system and sending it back to the malicious actors through web requests (along with your IP, [~~but that doesn't really matter~~](https://www.reddit.com/r/YouShouldKnow/comments/yem70s/ysk_that_leaking_your_ip_is_not_a_big_deal/)); installing a keylogger on your system; getting access to your browser's cookies to remotely authentithicate into your accounts, and much, much more! Every bad thing that can be done to you computer that you can think of can probably be done with KubeJS scripts. And all one has to do - is to launch a modpack instance.

Sounds pretty scary huh? Well it sure did to Lat, who, in an attempt to stop such use, implemented a system called the "class filter". The idea is quite simple and self-explanatory: add a list of classpaths to Kube's code, and when a reflection is initiated in one of the scripts - check that list and throw an error if the provided path is not included. And all lived in peace... *until the end users arrived.* See, the whitelist system first implemented was extremely limiting, and slowly more and more possible allowed class ideas flooded Lat's head until he realized that the model used would only lead to the project being stuck with a semi-useless feature, and that for it to reach its true potential something had to be changed. That's when [*an important patch* was pushed](https://github.com/KubeJS-Mods/KubeJS/commit/c7014704bc6217cc1662847548239d4d62db147b), which would both shape modern Kube as we know it, and lead to *the downward spiral* the consequences of which we are still suffering through today...

# Welcome to modernity

After commit `c701470`, a new config option was introduced. It was added silently, and a lot of people still don't know it ever existed to this day: it was not clearly stated in any of the changelogs, the docs on it did not and still do not exist, no value is attached to it in the config that is generated by default - hell, the only two ways you could figure out it exists is either by looking through the code yourself (which nobody does) or by catching a glimpse of someone mentioning it on the latvian.dev Discord server. However, all of that secrecy was for a good reason - see, the config option `c701470` added was called `invertClassLoader`, which, as the name suggests, allowed users to switch out the whitelist system of allowed classes - to a blacklist one. This means that, in theory, any class, **unless specifically blocked by KJS' developers**, can be *reflected*. You can probably see where I am going with this.

It is almost *impossible* to block every single class that can be used for malicious purposes - and even if you do, the *easiest* workaround for this is to simply install a poorly coded mod that, for some bullshit reason, reimplements a blocked class under a different classname - and you're done, all of the handcuffs are off. You can then reflect that new class and do whatever you please - including the nasty stuff from the list from the beginning of the blogpost. From the Kube developers' perspective, the only two ways to stop this exploit from happening is to either a. go back to the whitelist model (which is basically impossible now, the cat's out of the bag, packdevs will complain) or b. block that mod's reimplementation directly inside of KJS' code. The second option is a temporary fix however, as it will only work up until a new garbage mod gets released, and then that gets blocked - after which it just turns into an endless game of cat and mouse: Kube's devs trying to catch and block all of the poorly coded mods, while new ones are being pumped to CurseForge every day (especially now, with the ever-increasing popularity of *Mcreator slop*). Even KJS itself uses a variation of this scheme to implement its builtin `JsonIO` feature, which allows for partial filesystem access (usually, this would be a no-no for reflection).

<p align="center">
    <img src="https://i.imgur.com/niXzl6p.png">
    <br>
    <i>Scary function! Class filter forbids reflection under any circumstances!!</i>
</p>

<p align="center">
    <img src="https://i.imgur.com/7Hd3acr.png">
    <br>
    <i>oh wait this is not in the class filter...</i>
</p>

Eventually the config option was dropped, and the blacklist has become the new default - making it even easier to exploit. Besides the easiest tactic described in the previous paragraph, even builtin classes can sometimes cause trouble - ones seeming harmless at first can, through a combination of weird tricks, allow for unintended results. This truly becomes extremely similar to the cyberwarfare we see in things like server security - but now with *Minecraft modpacks* - things most players don't expect to cause harm to their PCs. Kube's team, acting as guards, are supposed to find every single way to exploit innocent features in all sorts of different classes and update the blacklist appropriately - while attackers can find and take advantage of the things that haven't yet caught the guards' eyes.

I am not that knowledgeable on this specific topic - I am not a security researcher - nor do I do enough cursed shit with either JS or Java to know every little quirk of them. However, I do know a person who *is* knowledgeable enough - he has, in fact, discovered an exploit in KJS' class filter himself before, and was nice enough to take a minute out of his day to describe some technical detail behind how that worked. So for the next part, I welcome another Modern Modpacks member and a fellow KubeJS enjoyer - tizu, to showcase an example of one such quirk:

# Abusing KubeJS without JavaScript

KubeJS and its class filter has come a long way. However, it isn't and never will be perfect. I was browsing Discord as usual, until I suddenly came across a message that I thought was quite interesting. Something I had never seen before. The [LWJGL System package](https://javadoc.lwjgl.org/org/lwjgl/system/package-summary.html). For context, LWJGL is the library Minecraft uses on the client for rendering and such. While looking through the Javadoc (linked above) I noticed that there seems to be a [package related to JNI](https://javadoc.lwjgl.org/org/lwjgl/system/jni/package-summary.html).

JNI is a part of the Java runtime - a (generally) pretty nice feature called Java Native Interface, allowing other languages to interact with the Java instance. Upon further checks, this *was* not in the KubeJS class filter. After reading the docs for "a bit" (2 days), I managed to build a simple JNI agent in *C++* (I hate C++!) - and so I eventually ran it in a normal (non-Minecraft) Java runtime. And it worked. It didn't do that much, but it was able to do pretty much anything you can do in Java - without a class filter. After some struggles, I managed to turn the C++ application I built into Base64. After tons of struggles, I was able to use the `org.lwjgl.system` package to run native C++ code from JavaScript.

After doing this I promptly contacted Lat and sent him a few example scripts (if I remember correctly), as I was too afraid of creating an issue or a PR for a possible security vulnerability, both of which leave up-to-date KubeJS versions vulnerable while leaking how the exploit works. While I hope no one has abused this - I'll be honest, it is quite complicated - it just goes to show that the class filter *is not perfect*. It never will be.

# MixinJS has been a disaster for the human race

So, we've figured out how we can bring the class filter down to its knees using poorly coded mods and even Java classes built directly into Minecraft. But not only is the implementation of this "security measure" incompetent, it can also be harmful. So let's now turn our attention to another negative aspect of the class filter - how it makes some features inconvenient, if not downright impossible to implement. Logically, the filter *is* supposed to be kind of a compromise which will allow for increased end user safety, in exchange for some of the features being taken away from script developers. This can be best seen in the following example - say you want to implement *a live-updating leaderboard of the players that have beaten your pack the fastest* - you wouldn't be able to do so with Kube.
Web requests, needed for implementing such a feature, can also potentially be used to leak your IP along with some other more sensitive data back to bad actors. This landed the classes related to requests into the classname blocklist. However, when you combine this concept with how flawed the class filter system is, and how easy it is to circumvent, you can see how it is not only useless at stopping actual malicious code from being executed on modpack players' systems, but how it can also be detrimental to regular conscientious packdevs.

Enter **MixinJS** - a beautiful concept which would, if implemented, allow people who know what they are doing to replace up to 75% of leftover mods in their modpacks with simple JS scripts. It was originally thought of by multiple people on the latvian.dev Discord server, and initially received public's (and Lat's) full support. It was all going well and good - a couple of test Implementations were created by people here and there, discussion of extra features were ongoing... and then someone mentioned a simple concept: "what if someone used mixinjs, to mixin into the class filter and remove it?". All hell broke loose - once Lat has heard about this idea, he ordered one of the most prominent community members - [Liopyu](https://github.com/liopyu) - to stop work on his prototype of mixinjs (which was the most promising one at the time) and scrap the code he'd written for it up until then entirely. Same was done for a couple of other people's implementations.

Now, I think it's important to mention that while yes, KJS' team did often fix the security issues that arose with the class filter, **their main weapon against them was to just shutdown all discussion about them and silence the original reporter, then pray people don't notice what happened and don't take it to the places outside of their control** (which is exactly what I am doing right now - fun fact: this blogpost has a high chance of getting me banned off of Lat's Discord server!). Because of this, when mixinjs turned from a prosperous idea into a tabooed topic, the public's opinion on it started to shift into the negative side. People were discussing potential concerns of such mod undermining the concept of the *sacred class filter* instead of focusing on truly cool things it would allow developers to do.

Fast forward to a couple of days ago. A little-known developer by the name of [FengMing3093](https://github.com/3093FengMing) after months of work released *the MixinJS.* Literally - a mod called `MixinJs` had popped up on CurseForge. It went unnoticed for a couple of days, only amassing a double digit number of downloads; then, latvian.dev discovered it. As you can probably guess - they weren't very happy - in fact, after some of its members discovered that the mod implemented a way to bypass the class filter, they conspired and succeeded in mass reporting the mod and getting it taken down from CF. The developer, reasonably, tried to argue their point and politely asked to get their work that they've put multiple hours into reinstated, proposing multiple compromises with various number of concessions, only to hear something about the *sacred class filter* as a response - which threw all the precious time and effort spent on the mod down the drain.

<p align="center">
    <img src="https://i.imgur.com/TkVeEJk.png">
    <br>
    <i>What could have been... (thanks zzzank for the screenshot)</i>
</p>

Now, at some point of reading this, a question had to pop up in your mind: "Why does the class filter even exist? Doesn't it just arbitrarily limit features that are already very much possible to do by simply coding a custom mod, while only providing faux-security in return?". And to answer that - we should now mention the last party involved in this whole ordeal that I've been neglecting talking about up until this point: **the CurseForge admins.**

# Shifting the blame

These days, there are no physical differences between KubeJS scripts and actual mods. You can lie to yourself all you want, say that's not true, that JS scripts are somehow less value than full on mod jars - but if you look at it objectively: 95% of what mods are able to do, scripts are also capable of - that's how far we've come. In some cases (for example, cross-loader compatibility), scripts are even doing better than mods.

Unfortunately, there is one aspect where mods beat out scripts - and it's not one that is solvable by script developers, or Kube devs, or developers of Kube forks (like us), or even end users. And that aspect is the preferential treatment mods have over scripts inside of our minds. If the statement I made in the beginning of the previous paragraph invoked a negative reaction in you - you are a victim of this logical fallacy. I believe that it mostly comes from the early days of modpack development, back in the days when CraftTweaker *was* the only option - and the tools it had were nowhere close to the ones modern versions of it have. You are not to blame for thinking that - nobody is, that's just how our brains work.

Where this *does* become a problem, is when admins of large platforms we rely on become subject to this. Of course, I am referring to CurseForge, and how their policy of *manual modpack reviewal* has not evolved over the years. It is because of this fallacy that the class filter exists - it is because of this fallacy that mods are subject to malware inspection and scripts aren't - it is because of this fallacy Lat is so scared of letting mods like mixinjs release - it is because of this fallacy we as a community cannot move forward, and are always stuck one step away from being able to implement the features of our dreams.

Modpack scoreboards, content updates downloaded directly from the server, various integrations with different APIs (ex. a discord bot that can track your progress in a pack), image/text editing programs built with Kube's painter feature that can save filtes directly to your PC, various mixins extending various mod features, and so, so much more. *All of that* currently either requires roundabout ways to implement (ex. very specific Kube addons) or are not possible at all to do with KJS - and the only reason for that is, you guessed it, *the class filter.* **The goddamned class filter.** A feature that only exists to not inconvenience CurseForge admins. To not shift the blame on them - to not make them do extra work of checking whether a modpack is safe to run or not (the work that, in my opinion, is completely on them to do). And even that is done poorly, with so many different loopholes that any decent security analyst (or just a human with ears and eyes) will be able to detect and take advantage of. And don't you dare talk about these issues  publicly - or you'll get banished to the shadow realm.

I feel like there exists a solution though, and quite simple at that. A solution that would benefit all of us, and make the impossible possible. A solution that only requires input from two groups of people, and will improve the safety drastically. This solution feels so obvious and so weird to say, but:

* Dear CurseForge admins, please check modpacks the same way you do mods. They ***can*** include malware, they ***can*** launch arbitrary code on user's PCs, make that the base assumption. Why is it that after fracturizer, you have installed a new system to check mods for that sort of stuff, but the same system hasn't been used for modpacks? Or do we have to wait for another incident, this time related to rouge KJS scripts to appear? It's not only Kube with addons such as mixinjs that can cause such harm. Recently, there was a big drama that has hit the [FancyMenu](https://www.curseforge.com/minecraft/mc-mods/fancymenu) community about whether they should keep the methods allowing to call arbitrary commands on user computers. They were eventually scrapped... and transferred to [a separate addon](https://www.curseforge.com/minecraft/mc-mods/fancymenu-system-interactions-addon) that is *still up on your servers.* You should decide: you either block all kinds of such mods from your platform, and slow down progress and creative ideas by a lot; or start checking modpacks for malicious use of such mods (similarly with how you do it right now with mod jars), allowing those who just use them as a tool to implement new and innovative things into their creations. The choice is yours, but in my opinion, as with Lat once and for all deciding to use blacklist instead of whitelist, you should go with the second option, since the cat is about to jump out of the bag, and you gotta be prepared for it.
* Modrinth team, the last point concerns y'all too! Albeit, in a lesser sense, since you have less people and resources to check for malicious stuff in mods, not even talking about modpacks.
* Dear Lat, stop trying to censor every discussion of loopholes inside of your systems, instead get on fixing them - or at least tell other KJS contributors to figure out a fix for them. You cannot solve an issue by hiding from it, someday it will get out - and will haunt you for the rest of your days.

I strongly believe that, by following this simple piece of advice, with a bit of human touch, modpacks can become safer for end users, while not compromising on innovative features. **It will make the class filter obsolete**, and we'll be able to finally move on as a community from this relic of the past.

KubeJS scripts *are* inherently unsafe, so why not embrace it? Thank you for reading, my name's G_cat, happy halloween, and see you in another one.

Bye!